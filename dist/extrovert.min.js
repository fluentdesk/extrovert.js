/*! extrovert.js 22-07-2019 */

!function(e,t){"function"==typeof define&&define.amd?define(["three","physijs"],t):e.extrovert=t(e.THREE,e.Physijs)}(this,function(V,e){var t,i,r,f,n,a,h,m,v,g,y,b,o,s,x;function w(e,t){return o.call(e,t)}function l(e,t){var r,i,o,n,a,s,l,c,u,p,d,f=t&&t.split("/"),h=y.map,m=h&&h["*"]||{};if(e){for(a=(e=e.split("/")).length-1,y.nodeIdCompat&&x.test(e[a])&&(e[a]=e[a].replace(x,"")),"."===e[0].charAt(0)&&f&&(e=f.slice(0,f.length-1).concat(e)),u=0;u<e.length;u++)if("."===(d=e[u]))e.splice(u,1),u-=1;else if(".."===d){if(0===u||1===u&&".."===e[2]||".."===e[u-1])continue;0<u&&(e.splice(u-1,2),u-=2)}e=e.join("/")}if((f||m)&&h){for(u=(r=e.split("/")).length;0<u;u-=1){if(i=r.slice(0,u).join("/"),f)for(p=f.length;0<p;p-=1)if(o=(o=h[f.slice(0,p).join("/")])&&o[i]){n=o,s=u;break}if(n)break;!l&&m&&m[i]&&(l=m[i],c=u)}!n&&l&&(n=l,s=c),n&&(r.splice(0,s,n),e=r.join("/"))}return e}function C(t,r){return function(){var e=s.call(arguments,0);return"string"!=typeof e[0]&&1===e.length&&e.push(null),a.apply(f,e.concat([t,r]))}}function k(t){return function(e){v[t]=e}}function z(e){if(w(g,e)){var t=g[e];delete g[e],b[e]=!0,n.apply(f,t)}if(!w(v,e)&&!w(b,e))throw new Error("No "+e);return v[e]}function c(e){var t,r=e?e.indexOf("!"):-1;return-1<r&&(t=e.substring(0,r),e=e.substring(r+1,e.length)),[t,e]}function j(e){return e?c(e):[]}return v={},g={},y={},b={},o=Object.prototype.hasOwnProperty,s=[].slice,x=/\.js$/,h=function(e,t){var r,i=c(e),o=i[0],n=t[1];return e=i[1],o&&(r=z(o=l(o,n))),o?e=r&&r.normalize?r.normalize(e,function(t){return function(e){return l(e,t)}}(n)):l(e,n):(o=(i=c(e=l(e,n)))[0],e=i[1],o&&(r=z(o))),{f:o?o+"!"+e:e,n:e,pr:o,p:r}},m={require:function(e){return C(e)},exports:function(e){var t=v[e];return void 0!==t?t:v[e]={}},module:function(e){return{id:e,uri:"",exports:v[e],config:function(e){return function(){return y&&y.config&&y.config[e]||{}}}(e)}}},n=function(e,t,r,i){var o,n,a,s,l,c,u,p=[],d=typeof r;if(c=j(i=i||e),"undefined"==d||"function"==d){for(t=!t.length&&r.length?["require","exports","module"]:t,l=0;l<t.length;l+=1)if("require"===(n=(s=h(t[l],c)).f))p[l]=m.require(e);else if("exports"===n)p[l]=m.exports(e),u=!0;else if("module"===n)o=p[l]=m.module(e);else if(w(v,n)||w(g,n)||w(b,n))p[l]=z(n);else{if(!s.p)throw new Error(e+" missing "+n);s.p.load(s.n,C(i,!0),k(n),{}),p[l]=v[n]}a=r?r.apply(v[e],p):void 0,e&&(o&&o.exports!==f&&o.exports!==v[e]?v[e]=o.exports:a===f&&u||(v[e]=a))}else e&&(v[e]=r)},t=i=a=function(e,t,r,i,o){if("string"==typeof e)return m[e]?m[e](t):z(h(e,j(t)).f);if(!e.splice){if((y=e).deps&&a(y.deps,y.callback),!t)return;t.splice?(e=t,t=r,r=null):e=f}return t=t||function(){},"function"==typeof r&&(r=i,i=o),i?n(f,e,t,r):setTimeout(function(){n(f,e,t,r)},4),a},a.config=function(e){return a(e)},t._defined=v,(r=function(e,t,r){if("string"!=typeof e)throw new Error("See almond README: incorrect module build, no module name");t.splice||(r=t,t=[]),w(v,e)||w(g,e)||(g[e]=[e,t,r])}).amd={jQuery:!0},r("../node_modules/almond/almond",function(){}),r("extrovert/options/version",{major:0,minor:1,patch:3,str:"0.1.3"}),r("extrovert/options/defaults",{renderer:"Any",gravity:[0,0,0],camera:{fov:35,near:1,far:1e4,position:[0,0,200]},controls:{type:"universal",enabled:!0,allow_drag:!1},physics:{provider:"physijs",enabled:!0,options:{worker:"/js/pjsworker.js",ammo:"ammo.js"}},block:{depth:1},move_with_physics:!0,clickForce:9e5,onload:null,onerror:null,created:null,clicked:null,lights:[{type:"ambient",color:16777215}]}),r("extrovert/utilities/is",[],function(){return{array:function(e){return"[object Array]"===Object.prototype.toString.call(e)},string:function(e){return"string"==typeof object},plainObject:function(e){return!("object"!=typeof e||e.nodeType||null!==e&&e===e.window)&&!(e.constructor&&!hasOwnProperty.call(e.constructor.prototype,"isPrototypeOf"))}}}),r("extrovert/utilities/extend",["./is"],function(d){return function e(t){var r,i,o,n,a,s,l=t||{},c=1,u=arguments.length,p=!1;for("boolean"==typeof l&&(p=l,l=arguments[c]||{},c++),"object"!=typeof l&&"function"!=typeof l&&(l={});c<u;c++)if(null!==(r=arguments[c]))for(i in r)o=l[i],l!==(n=r[i])&&(p&&n&&(d.plainObject(n)||(a=n.constructor===Array))?(s=a?(a=!1,o&&o.constructor===Array?o:[]):o&&d.plainObject(o)?o:{},l[i]=e(p,s,n)):void 0!==n&&(l[i]=n));return l}}),r("extrovert/options/options",["./defaults","../utilities/extend"],function(t,r){var i={init:function(e){return i.user=e,i.merged=r(!0,{},t,e),i.merged},defaults:t,user:null,merged:null};return i}),r("extrovert/utilities/cookie",[],function(){return{getCookie:function(e){e=e.toLowerCase();for(var t=document.cookie.split(";"),r=0;r<t.length;r++){var i=t[r].split("="),o=decodeURIComponent(i[0].trim().toLowerCase()),n=1<i.length?i[1]:"";if(o==e)return decodeURIComponent(n)}return""},setCookie:function(e,t){var r=new Date;r.setYear(r.getFullYear()+1);var i=encodeURIComponent(e)+"="+encodeURIComponent(t)+";expires="+r.toGMTString()+";path=/";document.cookie=i},clearCookie:function(e){my.setCookie(e,"")}}}),r("extrovert/utilities/getComputedStyle",[],function(){return function(e,t){var r,i,o,n,a=e.ownerDocument.defaultView;return a&&a.getComputedStyle?(t=t.replace(/([A-Z])/g,"-$1").toLowerCase(),a.getComputedStyle(e,null).getPropertyValue(t)):e.currentStyle?(t=t.replace(/\-(\w)/g,function(e,t){return t.toUpperCase()}),r=e.currentStyle[t],/^\d+(em|pt|%|ex)?$/i.test(r)?(i=r,o=e.style.left,n=e.runtimeStyle.left,e.runtimeStyle.left=e.currentStyle.left,e.style.left=i||0,i=e.style.pixelLeft+"px",e.style.left=o,e.runtimeStyle.left=n,i):r):void 0}}),r("extrovert/utilities/detect",[],function(){return{supportsWebGL:function(e){if(window.WebGLRenderingContext){for(var t=document.createElement("canvas"),r=["webgl","experimental-webgl","moz-webgl","webkit-3d"],i=!1,o=0;o<4;o++)try{if((i=t.getContext(r[o]))&&"function"==typeof i.getParameter)return!e||{name:r[o],gl:i}}catch(e){}return!1}return!1},supportsCanvas:function(){var e=document.createElement("canvas");return!(!e.getContext||!e.getContext("2d"))}}}),function(e,t){"use strict";"function"==typeof r&&r.amd?r("in.scribe",[],t):"object"==typeof exports?module.exports=t():e.inscribe=t()}(window,function(){"use strict";var o=function(){return{inscribe:function(e,t,r,i){o["_render"+(t||"text")].call(this,r,e,i)},fit:function(e,t,r,i){var o=i.leftTop[0]-i.rightBottom[0],n=i.leftTop[1]-i.rightBottom[1],a=0;do{a++,r.font=a+"px sans-serif";var s=r.measureText(e)}while(s.width<=o&&s.height<=n);if(1===a)return!1;r.font=a-1+"px sans-serif",context.fillText(txtLine,pos[0],pos[1])},wrapText:function(e,t,r,i,o,n,a){for(var s=1,l=!0,c="",u="",p=[0,0],d=t.split("\n"),f=0;f<d.length;f++){var h=d[f].split(" ");l=!0,c="";for(var m=0;m<h.length;m++){u=c+(l?"":" ")+h[m];var v=e.measureText(u);v.width<=o?(l=!1,c=u):((v=e.measureText(c)).width>p[0]&&(p[0]=v.width),a||e.fillText(c,r,i),l=!0,i+=n,p[1]=i,s++,c=h[m],(v=e.measureText(c)).width<=o&&(l=!1))}a||e.fillText(c,r,i),i+=n,p[1]=i}return{numLines:s,extents:p}}}};return o._rendertext=function(l,e,c){var r=c.padding||10,u=c.maxWidth?c.maxWidth-2*r:492,i=c.lineHeight||16,o=[r,r+i],p=e.split("\n"),n=0;function d(e,t){l.fillText(e,o[0],o[1]),c.lineEmitted&&c.lineEmitted(e,n),n%c.chunkSize!=c.chunkSize-1&&!t||(c.pageEmitted&&(l=c.pageEmitted(l)),o[0]=o[1]=r),o[1]+=i,++n}return p.reduce(function(e,t,r){var i=t.split(" "),o="";i[0]=(c.firstLineIndent||"   ")+i[0];for(var n=0;n<i.length;n++){var a=o+(0<o.length?" ":"")+i[n],s=l.measureText(a).width>u;!s&&(o=a,n<i.length-1)||(d(o,!1),o=s?i[n]:"")}r===p.length-1&&d(o,!0)},{}),{numLines:n}},o._renderhtml=function(e,t,r,i){},o._renderdom=function(e,t,r,i){},o}),r("extrovert/utilities/utils",["require","three","./cookie","./getComputedStyle","./detect","in.scribe"],function(e,t,r,i,o,n){var a;return{VZERO:new t.Vector3(0,0,0),shadeBlend:e("./blend"),getCookie:r.getCookie,setCookie:r.setCookie,clearCookie:r.clearCookie,getComputedStyle:i,wrapText:(new n).wrapText,detectWebGL:o.supportsWebGL,detectCanvas:o.supportsCanvas,registerEvent:function(e){return(a=a||{})[e]=document.createEvent("Event"),a[e].initEvent(e,!0,!0),a[e]},fireEvent:function(e){document.dispatchEvent(a[e])}}}),r("extrovert/utilities/sel",[],function(){return function(e){return document.querySelectorAll(e)}}),r("extrovert/utilities/log",[],function(){return{msg:function(){var e=Array.prototype.slice.call(arguments);e[0]="EXTRO: "+e[0],console.log.apply(console,e)},warn:function(){var e=Array.prototype.slice.call(arguments);e[0]="EXTRO: "+e[0],console.warn.apply(console,e)},error:function(){var e=Array.prototype.slice.call(arguments);e[0]="EXTRO: "+e[0],console.error.apply(console,e)}}}),r("extrovert/utilities/offset",[],function(){return function(e){var t,r,i={top:0,left:0},o=e&&e.ownerDocument;if(o)return t=o.documentElement,void 0!==e.getBoundingClientRect&&(i=e.getBoundingClientRect()),r=null!==o&&o===o.window?o:9===o.nodeType&&o.defaultView,{top:i.top+r.pageYOffset-t.clientTop,left:i.left+r.pageXOffset-t.clientLeft}}}),r("extrovert/providers/three/provider-three",["extrovert/options/options","three","physijs"],function(n,a,s){"use strict";var e={};function l(e,t,r,i,o){return n.merged.physics.enabled&&!i?new s[t+"Mesh"](e,r,o):new a.Mesh(e,r)}function c(e){var t=new a.SpotLight(e.color);return t.shadowCameraVisible=!1,t}return e.createCamera=function(e){var t="orthographic"!=e.type?new a.PerspectiveCamera(e.fov,e.aspect,e.near,e.far):new a.OrthographicCamera(e.left,e.right,e.top,e.bottom,e.near,e.far);return e.position&&t.position.set(e.position[0],e.position[1],e.position[2]),e.up&&t.up.set(e.up[0],e.up[1],e.up[2]),e.lookat&&t.lookAt(new a.Vector3(e.lookat[0],e.lookat[1],e.lookat[2])),t.updateMatrix(),t.updateMatrixWorld(),t.updateProjectionMatrix(),t},e.createMaterial=function(e){var t=new a.MeshLambertMaterial({color:e.color||16777215,map:e.tex||null});return n.merged.physics.enabled&&!e.noPhysics?s.createMaterial(t,e.friction||.2,e.restitution||1):t},e.createMaterialFromCanvas=function(e,t){var r=new a.Texture(e);return r.needsUpdate=t||!1,{tex:r,mat:new a.MeshLambertMaterial({map:tex})}},e.loadTexture=function(e){return a.ImageUtils.loadTexture(e)},e.createTextureFromCanvas=function(e,t){var r=new a.Texture(e);return r.needsUpdate=t||!1,r},e.createCubeMaterial=function(e){return new a.MeshFaceMaterial(e)},e.createObject=function(e){var t=null,r=e.color||16777215,i=e.opacity||1,o=e.transparent||!1;return"box"===e.type?t=l(new a.BoxGeometry(e.dims[0],e.dims[1],e.dims[2]),"Box",e.mat||new a.MeshLambertMaterial({color:r,opacity:i,transparent:o}),!1,e.mass):"plane"===e.type&&(t=l(new a.PlaneBufferGeometry(e.dims[0],e.dims[1]),null,e.mat||new a.MeshBasicMaterial({color:r,opacity:i,transparent:o}),!0,e.mass)),e.pos&&t.position.set(e.pos[0],e.pos[1],e.pos[2]),e.rot&&t.rotation.set(e.rot[0],e.rot[1],e.rot[2],"YXZ"),!1===e.visible&&(t.visible=!1),t.castShadow=t.receiveShadow=!1,t},e.fiatLux=function(e,t){if(e&&0!==e.length){for(var r=[],i=null,o=0;o<e.length;o++){var n=e[o];if("ambient"===n.type)i=new a.AmbientLight(n.color,n.intensity);else if("point"===n.type)i=new a.PointLight(n.color,n.intensity,n.distance);else if("spotlight"===n.type)i=c(n);else if("hemisphere"===n.type)i=new a.HemisphereLight(n.color,n.groundColor,n.intensity);else{if("directional"!==n.type)return;i=new a.DirectionalLight(n.color,n.intensity)}"ambient"!==n.type&&"hemisphere"!==n.type&&(n.pos?i.position.set(n.pos[0],n.pos[1],n.pos[2]):i.position.copy(t.camera.position)),r.push(i)}return r}},e}),r("extrovert/rasterizers/paint-img",["extrovert/providers/three/provider-three"],function(t){"use strict";return{paint:function(e){return t.loadTexture("string"==typeof e?e:e.src)}}}),r("extrovert/rasterizers/paint-element",["extrovert/providers/three/provider-three","extrovert/utilities/utils"],function(n,a){"use strict";return{paint:function(e,t){var r=document.createElement("canvas"),i=r.getContext("2d");r.width=e.offsetWidth,r.height=e.offsetHeight;var o=a.getComputedStyle(e,"background-color");return"rgba(0, 0, 0, 0)"===o&&(o="rgb(0,0,0)"),i.fillStyle=o,i.fillRect(0,0,r.width,r.height),n.createTextureFromCanvas(r,!0)}}}),r("extrovert/utilities/blend",[],function(){return function(e,t,r){var i=e<0?-1*e:e,o=Math.round,n=parseInt;if(7<t.length){var a=t.split(","),s=(r||(e<0?"rgb(0,0,0)":"rgb(255,255,255)")).split(","),l=n(a[0].slice(4)),c=n(a[1]),u=n(a[2]);return"rgb("+(o((n(s[0].slice(4))-l)*i)+l)+","+(o((n(s[1])-c)*i)+c)+","+(o((n(s[2])-u)*i)+u)+")"}var p=(a=n(t.slice(1),16))>>16,d=a>>8&255,f=255&a;return"#"+(16777216+65536*(o((((s=n((r||(e<0?"#000000":"#FFFFFF")).slice(1),16))>>16)-p)*i)+p)+256*(o(((s>>8&255)-d)*i)+d)+(o(((255&s)-f)*i)+f)).toString(16).slice(1)}}),r("extrovert/rasterizers/paint-plain-text",["../utilities/utils","../providers/three/provider-three","../utilities/blend","in.scribe"],function(c,u,p,d){"use strict";return{paint:function(e,t,r){t=t||{};var i=document.createElement("canvas"),o=i.getContext("2d");i.width=t.width,i.height=t.height;var n=t.bkColor||"rgb(255,255,255)";o.fillStyle=n,o.fillRect(0,0,i.width,i.height),o.font=c.getComputedStyle(document.body,"font"),o.fillStyle=t.bkColor||"rgb(0,0,0)";var a=new d,s=a.wrapText(o,e.title,10,24,i.width-20,14,!0);o.fillStyle=p(-.25,n),o.fillRect(0,0,i.width,20+14*s),o.fillStyle=t.textColor||"rgb(255,255,255)",s=a.wrapText(o,e.title,10,24,i.width-20,14,!1);var l=e.text.replace("\n"," ");return s=a.wrapText(o,l,10,20+14*s+16,i.width-20,16,!1),r.numLines=s,u.createTextureFromCanvas(i,!0)}}}),r("extrovert/rasterizers/paint-plain-text-stream",["extrovert/utilities/utils","extrovert/providers/three/provider-three","in.scribe"],function(p,d,f){"use strict";return{paint:function(e,o,t){o=o||{};var r=new f,n=[],i=o.lineHeight||16,a=e.text,s=o.padding||10;t.numLines=0;var l=document.createElement("canvas"),c=l.getContext("2d");l.width=o.width,l.height=o.height;var u=o.bkColor||"rgb(255,255,255)";return c.fillStyle=u,c.fillRect(0,0,l.width,l.height),c.font=p.getComputedStyle(document.body,"font"),c.fillStyle=o.bkColor||"rgb(0,0,0)",r.inscribe(a,"text",c,{padding:s,maxWidth:l.width,lineHeight:i,chunkSize:35,pageEmitted:function(e){n.push(d.createTextureFromCanvas(e.canvas,!0));var t=document.createElement("canvas");t.width=o.width,t.height=o.height;var r=t.getContext("2d"),i=o.bkColor||"rgb(255,255,255)";return r.fillStyle=i,r.fillRect(0,0,t.width,t.height),r.font=p.getComputedStyle(document.body,"font"),r.fillStyle=o.textColor||"rgb(0,0,0)",r}}),n}}}),r("extrovert/generators/book",["require","../core","../utilities/log","extrovert/providers/three/provider-three"],function(e,t,b,x){"use strict";var w=null,C=null,k=null;function z(e,t,r){for(var i=0;i<e.faces.length;i++){var o=e.faceVertexUvs[0][i];if(.9<Math.abs(e.faces[i].normal.z))for(var n=0;n<3;n++)Math.abs(o[n].y)<.01&&(o[n].y=1-t/r)}e.uvsNeedUpdate=!0}return function(){var y=e("../core");e("../utilities/utils");return{options:{name:"book",material:{color:16777215,friction:.2,restitution:1},block:{depth:"height"},clickForce:5e3,dims:[512,814,2],pagify:!0,title:null,cover:null,doubleSided:!0,camera:{position:[0,0,400]}},init:function(e,t){w=e,C=t,y.createPlacementPlane([0,0,200]),k=x.createMaterial({color:e.pageColor||e.material.color,friction:e.material.friction,restitution:e.material.restitution})},generate:function(e,t){if(y.LOGGING&&b.msg("book.generate( %o, %o )",e,t),e.cover){var r=x.createMaterial({tex:x.loadTexture(e.cover),friction:.2,resitution:1});y.createObject({type:"box",pos:[0,0,0],dims:w.dims,mat:r,mass:1e3})}function i(e){return x.createMaterial({tex:e,friction:.2,restitution:1})}function o(e,t){return t%2==0}function n(e,t){return!o(0,t)}for(var a=0;a<t.length;a++){var s=e.adapt&&e.adapt(t[a])||t[a],l=null;if(l=e.rasterizer?"string"==typeof e.rasterizer?C.rasterizers[e.rasterizer]:e.rasterizer:C.rasterizers.paint_plain_text_stream,w.pagify)for(var c={width:w.texWidth||512,height:w.texHeight||1024,bkColor:w.pageColor||w.material&&w.material.color||16777215,textColor:w.textColor||2302755},u=l.paint(s,c,{}).map(i),p=u.filter(o),d=u.filter(n),f=0;f<p.length;f++){var h=[0,0,-f*w.dims[2]-w.dims[2]],m=[k,k,k,k,p[f],f<d.length?d[f]:k],v=x.createCubeMaterial(m),g=y.createObject({type:"box",pos:h,dims:w.dims,mat:v,mass:1e3});z(g.geometry,c.width,c.height),y.LOGGING&&b.msg("Generating page %o at position %f, %f, %f",g,h[0],h[1],h[2])}}}}}}),r("extrovert/generators/box",["extrovert/core"],function(l){"use strict";var c,u,p;return{options:{name:"box",material:{color:16746564,friction:.2,restitution:1},block:{width:250,height:250,depth:250}},init:function(e,t){c=e,t,u=l.provider.createMaterial(e.material),l.createPlacementPlane([0,0,0])},generate:function(e,t){var r,i,o;if(p=e,1===t.length)r=[o=this.rasterize(t[0]),o,o,o,o,o];else if(2===t.length)o=this.rasterize(t[0]),material2=this.rasterize(t[1]),r=[u,u,u,u,o,material2];else if(2<t.length){r=[];for(var n=6<t.length?6:t.length,a=0;a<n;a++)i=t[a],o=this.rasterize(i),r.push(o);for(;6!==r.length;)r.push(u)}var s=l.createCubeMaterial(r);l.createObject({type:"box",pos:[0,0,0],dims:[c.block.width,c.block.height,c.block.depth],mat:s,mass:1e3})},rasterize:function(e){var t=null;p.rasterizer&&(t="string"==typeof p.rasterizer?new l["paint_"+p.rasterizer]:p.rasterizer);var r=(t=t||l.getRasterizer(e)).paint(p.adapt&&p.adapt(e)||e,{width:c.block.width,height:c.block.height});return l.provider.createMaterial({tex:r,friction:.2,restitution:1})}}}),r("extrovert/generators/direct",["extrovert/core","extrovert/providers/three/provider-three"],function(e,c){"use strict";return function(){var n,r,a,s,l=i("extrovert/core");return{options:{name:"direct",material:{color:16746564,friction:.2,restitution:1},block:{depth:10},map:"fit"},init:function(e,t){n=e,r=t,a=c.createMaterial(e.material),l.createPlacementPlane([0,0,0])},generate:function(e,t){s=e;for(var r=0;r<t.length;r++){var i=t[r],o=this.transform(i),n=this.rasterize(i);l.createObject({type:"box",pos:o.pos,dims:[o.width,o.height,o.depth],mat:n,mass:1e3})}},transform:function(e){var t=s.container||r.opts.src&&r.opts.src.container||document.body;return l.getPositionDirect(e,t,n.block.depth,0)},rasterize:function(e){var t=null;s.rasterizer&&(t="string"==typeof s.rasterizer?l[s.rasterizer]:s.rasterizer);var r,i=(t=t||l.getRasterizer(e)).paint(s.adapt&&s.adapt(e)||e),o=c.createMaterial({tex:i,friction:.2,restitution:0});return n.map&&"all"!==n.map?("fit"==n.map&&(r=n.block.depth&&"height"!==n.block.depth?"width"===n.block.depth?[o,o,a,a,o,o]:[a,a,a,a,o,o]:[a,a,o,o,o,o]),c.createCubeMaterial(r)):o}}}}),r("extrovert/generators/extrude",["require","extrovert/core","extrovert/providers/three/provider-three"],function(e,t,n){"use strict";var a,s,l,p;return function(){var u=e("extrovert/core");return{options:{name:"extrude",material:{color:16746564,friction:.2,restitution:1},depth:1,map:"fit"},init:function(e,t){a=e,s=t,l=n.createMaterial(e.material),u.createPlacementPlane([0,0,0])},generate:function(e,t){var r=null;if("content-bottom"==(p=e).align)for(var i=r=0;i<t.length;i++){var o=$(t[i]),n=o.offset().top+o.height();r<n&&(r=n)}for(var a=0;a<t.length;a++){var s=t[a],l=this.transform(s,r),c=this.rasterize(s);u.createObject({type:"box",pos:l.pos,dims:[l.width,l.height,l.depth],mat:c,mass:1e3})}},transform:function(e,t){var r=p.container||s.opts.src&&s.opts.src.container||document.body;return u.getPosition(e,r,a.depth,t)},rasterize:function(e){var t=null;p.rasterizer&&(t="string"==typeof p.rasterizer?s.rasterizers[p.rasterizer]:p.rasterizer);var r,i=(t=t||u.getRasterizer(e)).paint(p.adapt&&p.adapt(e)||e),o=n.createMaterial({tex:i,friction:.2,restitution:0});return a.map&&"all"!==a.map?("fit"==a.map&&(r=a.depth&&"height"!==a.depth?"width"===a.depth?[o,o,l,l,o,o]:[l,l,l,l,o,o]:[l,l,o,o,o,o]),n.createCubeMaterial(r)):o}}}}),r("extrovert/generators/tile",["require","extrovert/core","extrovert/providers/three/provider-three"],function(e,t,h){return function(){var p=e("extrovert/core"),d=null,f=null;return{options:{name:"tile",material:{color:16746564,friction:.2,restitution:1},block:{depth:"height"},clickForce:9e5,rows:10,cols:10,dims:[250,500,2]},init:function(e,t){d=e,f=t,p.createPlacementPlane([0,0,200]),h.createMaterial(e.material)},generate:function(e,t){e;for(var r=0;r<t.length;r++){var i=t[r],o=Math.floor(r/d.cols),n=[r%d.cols*d.dims[0],o*d.dims[1],0],a=null;a=e.rasterizer?"string"==typeof e.rasterizer?f.rasterizers[e.rasterizer]:e.rasterizer:p.getRasterizer(i);var s=e.adapt&&e.adapt(i)||i,l={width:d.dims[0],height:d.dims[1],bkColor:d.bkColor,textColor:d.textColor},c=a.paint(s,l,{}),u=h.createMaterial({tex:c,friction:.2,restitution:1});p.createObject({type:"box",pos:n,dims:d.dims,mat:u,mass:1e3})}}}}}),r("extrovert/controls/universal-controls",["require","../core"],function(r,e){return function(e,t,i){var o=r("../core");this.object=e,this.domElement=t||document,this.enabled=!0,this.movementSpeed=1500,this.turboMultiplier=1;var n={},a=!1,s=new V.Vector2,l=new V.Vector3,c=new V.Vector3,u=new V.Vector3,p=!1;this.update=function(e){if(n.lookAt)(this.object.parent||this.object).lookAt(new V.Vector3(0,500,0));else if(a&&p){var t=u.x;u.x=-u.y,u.y=t;var r=this.object.rotation.toVector3().add(u.multiplyScalar(.65));this.object.rotation.setFromVector3(r,"YXZ"),p=!1}n.zdir&&this.object.translateZ(this.movementSpeed*e*n.zdir*this.turboMultiplier),n.xdir&&this.object.translateX(this.movementSpeed*e*n.xdir*this.turboMultiplier),n.ydir&&this.object.translateY(this.movementSpeed*e*n.ydir*this.turboMultiplier),i.yFloor&&this.object.position.y<i.yFloor&&(this.object.position.y=i.yFloor)},this.mousedown=function(e){var t=void 0===e.offsetX?e.layerX:e.offsetX,r=void 0===e.offsetY?e.layerY:e.offsetY;s.set(t,r),l=o.toNDC(t,r,.5,l),p=!(a=!0)},this.mouseup=function(e){p=a=!1},this.mousemove=function(e){if(a){e.preventDefault();var t=void 0===e.offsetX?e.layerX:e.offsetX,r=void 0===e.offsetY?e.layerY:e.offsetY;if(t===s.x&&r===s.y)return;c=o.toNDC(t,r,.5,c),u.subVectors(l,c),p=!0,s.set(t,r),l=o.toNDC(t,r,.5,l)}},this.mousewheel=function(e){var t=0;e.wheelDelta?t=e.wheelDelta/40:e.detail&&(t=-e.detail/3),this.object.translateZ(30*-t),e.preventDefault(),e.stopPropagation()},this.keydown=function(e){switch(e.keyCode){case 87:n.zdir=-1;break;case 83:n.zdir=1;break;case 65:n.xdir=-1;break;case 68:n.xdir=1;break;case 82:n.ydir=1;break;case 70:n.ydir=-1;break;case 32:n.lookAt=1;break;case 16:this.turboMultiplier=5}},this.keyup=function(e){switch(e.keyCode){case 87:case 83:n.zdir=0;break;case 65:case 68:n.xdir=0;break;case 82:case 70:n.ydir=0;break;case 32:n.lookAt=0;break;case 16:this.turboMultiplier=1}}}}),r("extrovert/core",["./options/version","./options/options","./options/defaults","./utilities/utils","./utilities/extend","./utilities/sel","./utilities/is","./utilities/log","./utilities/offset","./utilities/detect","./providers/three/provider-three","./rasterizers/paint-img","./rasterizers/paint-element","./rasterizers/paint-plain-text","./rasterizers/paint-plain-text-stream","./generators/book","./generators/box","./generators/direct","./generators/extrude","./generators/tile","./controls/universal-controls","physijs"],function(i,o,s,n,l,g,c,u,y,a,p,d,f,h,m,v,b,x,w,C,k,z){var j={},M={camera:null,scene:null,renderer:null,raycaster:new V.Raycaster,mouse:new V.Vector2,width:100,height:100,gravity:new V.Vector3(s.gravity[0],s.gravity[1],s.gravity[2]),selected:null,start_time:0,last_time:0,objects:[],drag_plane:null,placement_plane:null,offset:new V.Vector3,generator:null,clock:new V.Clock,supportsWebGL:!1,supportsCanvas:!1,target:"body"},_=null;j.LOGGING=!0,j.init=function(e,t){if(t=t||{},j.provider=p,j.LOGGING&&u.msg("Extrovert %s",i.str),j.LOGGING&&u.msg("User options: %o",t),M.supportsWebGL=a.supportsWebGL(),M.supportsCanvas=a.supportsCanvas(),!M.supportsWebGL&&!M.supportsCanvas||"WebGL"===t.renderer&&!M.supportsWebGL||"Canvas"===t.renderer&&!M.supportsCanvas)return!1;var r=window.navigator.userAgent;return(~r.indexOf("MSIE ")||~r.indexOf("Trident/"))&&Object.keys(V.ShaderLib).forEach(function(e){V.ShaderLib[e].fragmentShader=V.ShaderLib[e].fragmentShader.replace("#extension GL_EXT_frag_depth : enable","")}),function(e,t){M.target=e,M.userOpts=t,(_=M.opts=j.options=o.init(t)).physics.enabled&&"physijs"===_.physics.provider&&(z.scripts.worker=_.physics.options.worker,z.scripts.ammo=_.physics.options.ammo);M.rasterizers={img:d,element:f,plain_text:h,plain_text_stream:m},M.generators={extrude:w,tile:C,book:v,direct:x,box:b}}(e,t),function(e){if(M.target){var t="string"==typeof M.target?g(M.target):M.target;void 0!==t.length&&(t=t[0]);var r=t.getBoundingClientRect();M.width=r.right-r.left,M.height=r.bottom-r.top}else M.width=window.innerWidth,M.height=window.innerHeight;var i=e.renderer;i&&"Any"!==i||(i=M.supportsWebGL?"WebGL":M.supportsCanvas?"Canvas":null);var o="Canvas"===i?void 0:{antialias:!0};j.LOGGING&&u.msg("Creating '%s' renderer with size %d x %d.",i,M.width,M.height),M.renderer=new V[i+"Renderer"](o),M.renderer.setPixelRatio(window.devicePixelRatio),M.renderer.setSize(M.width,M.height),e.bkcolor&&M.renderer.setClearColor(e.bkcolor),M.renderer.domElement.setAttribute("tabindex","0"),M.renderer.domElement.style+=" position: relative;"}(_),function(a,t){j.createScene(a);var e=a.init_cam_opts?l(!0,{},a.camera,a.init_cam_opts):a.camera;"orthographic"===e.type?(e.left=e.left||t.width/-2,e.right=e.right||t.width/2,e.top=e.top||t.height/2,e.bottom=e.bottom||t.height/-2):e.aspect=t.width/t.height;var r=j.provider.createCamera(e);j.LOGGING&&u.msg("Created camera at [%f,%f,%f]: %o",r.position.x,r.position.y,r.position.z,r),t.camera=r,a.controls.allow_drag&&(t.drag_plane=j.createObject({type:"plane",dims:[2e3,2e3,8],visible:!1,color:0,opacity:.25,transparent:!0}));(function(e,t){if(t.scene&&t.scene.items)for(var r=0;r<t.scene.items.length;r++){var i=j.createObject(t.scene.items[r]);e.add(i)}})(t.scene,a),t.scene.updateMatrix();var i=a.transform||a.transforms||[{type:"extrude",src:"img"}];(i=c.array(i)?i:[i]).reduce(function(e,t,r){var i=t.src||"*",o=t.container||a.src&&a.src.container||a.container||document.body;"string"==typeof o&&void 0!==(o=g(o)).length&&(o=o[0]);var n="string"==typeof i?o.querySelectorAll(i):i;(function(e){var t=null;t=e.type?"string"==typeof e?new M.generators[e]:new M.generators[e.type]:new w;var r=l(!0,{},s,t.options);return r=l(!0,{},r,M.userOpts),r=l(!0,{},r,e),t.init&&t.init(r,M),t})(t).generate(t,n)},{});var o=a.camera;o.rotation&&t.camera.rotation.set(o.rotation[0],o.rotation[1],o.rotation[2],"YXZ"),o.positionNDC&&(o.position=j.ndcToWorld(o.positionNDC));o.position&&(t.camera.position.set(o.position[0],o.position[1],o.position[2]),j.LOGGING&&u.msg("Camera moved to [%f,%f,%f]: %o",o.position[0],o.position[1],o.position[2],r));p.fiatLux(a.lights,t).forEach(function(e){t.scene.add(e)})}(_,M),function(e){if(M.target){var t=e.action||"append",r="string"==typeof M.target?g(M.target):M.target;if(void 0!==r.length&&(r=r[0]),"replace"===t)for(;r.firstChild;)r.removeChild(r.firstChild);"replaceWith"!==t?r.appendChild(M.renderer.domElement):(r.parentNode.insertBefore(M.renderer.domElement,r),r.parentNode.removeChild(r))}}(_),function(e){e.physics.enabled&&(M.gravity.set(e.gravity[0],e.gravity[1],e.gravity[2]),M.scene.setGravity(M.gravity),M.scene.addEventListener("update",E))}(_),function(e,t){t.controls=j.createControls(e.controls,t.camera,t.renderer.domElement),t.controls}(_,M),n.registerEvent("extro.objectClick"),M.renderer.domElement.addEventListener("mousedown",S,!1),M.renderer.domElement.addEventListener("mouseup",G,!1),M.renderer.domElement.addEventListener("mousemove",O,!1),document.addEventListener("keydown",T,!1),document.addEventListener("keyup",P,!1),M.renderer.domElement.addEventListener("wheel",F,!1),window.addEventListener("resize",R,!1),function(e){if(e&&e.enabled){var t=j.createObject(e);M.camera.position.set(0,0,0),t.add(M.camera),M.scene.add(t),M.objects.push(t)}}(_.avatar),window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)},_.onload&&_.onload(),L(),!0};var e=window.jQuery;function L(){requestAnimFrame(L),function(){if(_.physics.enabled&&E(),M.controls&&M.controls.enabled&&M.controls.update(M.clock.getDelta()),!_.move_with_physics){null!==M.selected&&(M.selected.__dirtyPosition=!0);for(var e=0,t=M.objects.length;e<t;e++)M.objects[e].has_been_touched&&(M.objects[e].__dirtyPosition=!0)}M.renderer.clear(),M.css_renderer&&M.css_renderer.render(M.css_scene,M.camera),M.renderer.render(M.scene,M.camera)}()}function E(){M.scene.simulate()}function S(e){e.preventDefault();var t=void 0===e.offsetX?e.layerX:e.offsetX,r=void 0===e.offsetY?e.layerY:e.offsetY;if(M.mouse=j.toNDC(t,r,.5,M.mouse),_.avatar){var i=new V.Vector3;i.setFromMatrixPosition(M.camera.matrixWorld),M.raycaster.ray.origin.copy(i),M.raycaster.ray.direction.set(M.mouse.x,M.mouse.y,.5).unproject(M.camera).sub(i).normalize()}else M.raycaster.setFromCamera(M.mouse,M.camera);var o=M.raycaster.intersectObjects(M.objects);if(0!==o.length){if(_.objectClicked&&!1===_.objectClicked(e,o))return;e.ctrlKey?(M.selected=o[0].object,M.selected.has_been_touched=!0,M.drag_plane.position.copy(M.selected.position),M.offset.copy(o[0].point).sub(M.selected.position),_.physics.enabled?(M.selected.setAngularFactor(n.VZERO),M.selected.setLinearFactor(n.VZERO),M.selected.setAngularVelocity(n.VZERO),M.selected.setLinearVelocity(n.VZERO)):(M.selected.temp_velocity=M.selected.velocity.clone(),M.selected.velocity.set(0,0,0))):function(e){if(_.physics.enabled){var t=(new V.Matrix4).extractRotation(e.object.matrix),r=e.face.normal.clone().negate().multiplyScalar(_.clickForce).applyMatrix4(t),i=e.point.clone().sub(e.object.position);e.object.applyImpulse(r,i)}}(o[0])}_.clicked&&_.clicked(e,M.selected),M.controls&&M.controls.enabled&&M.controls.mousedown(e)}function O(e){if(M.controls&&M.controls.enabled)M.controls.mousemove(e);else{e.preventDefault();var t=void 0===e.offsetX?e.layerX:e.offsetX,r=void 0===e.offsetY?e.layerY:e.offsetY;if(M.mouse=j.toNDC(t,r,.5,M.mouse),M.selected){M.raycaster.setFromCamera(M.mouse,M.camera);var i=M.raycaster.intersectObject(M.drag_plane);if(_.move_with_physics){var o=i[0].point.sub(M.selected.position);o.z=0,M.selected.setLinearVelocity(o)}else M.selected.position.copy(i[0].point.sub(M.offset)),M.selected.__dirtyPosition=!0}}}function G(e){if(M.controls&&M.controls.enabled)M.controls.mouseup(e);else{if(e.preventDefault(),M.selected&&_.physics.enabled){if(_.physics.enabled){var t=new V.Vector3(1,1,1);M.selected.setAngularFactor(t),M.selected.setLinearFactor(t),M.selected.__dirtyPosition=!0}else{M.raycaster.setFromCamera(M.mouse,M.camera);var r=M.raycaster.intersectObject(M.drag_plane);M.selected.position.copy(r[0].point.sub(M.offset))}M.selected.updateMatrixWorld(),M.selected.updateMatrix()}M.selected=null}}function T(e){M.controls&&M.controls.enabled&&M.controls.keydown(e)}function P(e){M.controls&&M.controls.enabled&&M.controls.keyup(e)}function F(e){M.controls&&M.controls.enabled&&M.controls.mousewheel(e)}function R(){var e=M.renderer.domElement.parentNode.getBoundingClientRect();M.width=e.right-e.left,M.height=e.bottom-e.top,M.camera.aspect=M.width/M.height,M.camera.updateProjectionMatrix(),M.renderer.setSize(M.width,M.height)}return e&&(e.fn.extrovert=function(e){return this.each(function(){j.init(this,e)})}),j.getRasterizer=function(e){var t=null;return e instanceof HTMLImageElement?t=M.rasterizers.img:void 0!==e.nodeType?t=M.rasterizers.elem:j.Utils.isPlainObject(e)&&(t=M.rasterizers.plain_text),t},j.createObject=function(e){j.LOGGING&&u.msg("Creating object %o at [%f,%f,%f].",e,e.pos[0],e.pos[1],e.pos[2]);var t=j.provider.createObject(e);return M.scene.add(t),M.objects.push(t),t.updateMatrix(),t.updateMatrixWorld(),t},j.createControls=function(e,t,r){return"universal"===e.type?new k(t,void 0,e):null},j.createScene=function(e){return M.scene=e.physics.enabled?new z.Scene:new V.Scene,M.scene},j.screenToWorld=function(e,t,r,i){var o=j.toNDC(e,t,.5,new V.Vector2,i);M.raycaster.setFromCamera(o,M.camera);var n=r||M.placement_plane,a=M.raycaster.intersectObject(n);return 0<a.length?a[0].point:null},j.ndcToWorld=function(e,t){var r=new V.Vector3(e[0],e[1],e[2]);M.raycaster.setFromCamera(r,M.camera);var i=t||M.placement_plane,o=M.raycaster.intersectObject(i);return 0<o.length?[o[0].point.x,o[0].point.y,o[0].point.z]:null},j.getPosition=function(e,t,r,i){var o="string"==typeof t?g(t):t;void 0!==o.length&&(o=o[0]);var n,a,s=y(o),l=y(e),c={left:l.left-s.left,top:l.top-s.top};a=i?{x:(n={x:c.left,y:i-c.top,z:.5}).x+e.offsetWidth,y:i-(c.top-e.offsetHeight),z:.5}:{x:(n={x:c.left,y:c.top+e.offsetHeight,z:.5}).x+e.offsetWidth,y:c.top,z:.5};var u=Math.abs(a.x-n.x),p=Math.abs(n.y-a.y);"width"===r?r=u:"height"===r&&(r=p);var d=r||Math.abs(n.z-a.z)||1;return{pos:[n.x+u/2,n.y-p/2,n.z-d/2],width:u,height:p,depth:d}},j.getPositionDirect=function(e,t,r,i){var o="string"==typeof t?g(t):t;void 0!==o.length&&(o=o[0]);var n=y(o),a=y(e),s={left:a.left-n.left,top:a.top-n.top},l=s.left,c=s.top,u=i||0,p=s.left+e.offsetWidth,d=s.top+e.offsetHeight,f=i||0,h=Math.abs(p-l),m=Math.abs(c-d);"width"===r?r=h:"height"===r&&(r=m);var v=r||Math.abs(u-f)||1;return{pos:[l+h/2,c-m/2,u-v/2],width:h,height:m,depth:v}},j.createPlacementPlane=function(e,t){t=t||[2e5,2e5,1];var r=new V.BoxGeometry(t[0],t[1],t[2]);return M.placement_plane=_.physics.enabled?new z.BoxMesh(r,new V.MeshBasicMaterial({color:11215651,opacity:1,transparent:!1}),0):new V.Mesh(r,new V.MeshBasicMaterial({color:11215651,opacity:1,transparent:!1})),M.placement_plane.visible=!1,e&&M.placement_plane.position.set(e[0],e[1],e[2]),M.scene.updateMatrix(),M.placement_plane.updateMatrix(),M.placement_plane.updateMatrixWorld(),j.LOGGING&&u.msg("Created placement plane at [%o]: %o",M.placement_plane.position,M.placement_plane),M.placement_plane},j.toNDC=function(e,t,r,i,o){var n=(o||M).width,a=(o||M).height;return i.x=e/n*2-1,i.y=-t/a*2+1,i.z=r,i},j}),r("extrovert",["require","extrovert/options/version","extrovert/core","extrovert/utilities/utils"],function(e){"use strict";return{version:e("extrovert/options/version").str,init:e("extrovert/core").init,utils:e("extrovert/utilities/utils")}}),r("three",function(){return V}),r("physijs",function(){return e}),i("extrovert")});